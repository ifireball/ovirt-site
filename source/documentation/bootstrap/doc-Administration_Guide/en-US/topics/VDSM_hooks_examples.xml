<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "../Administration_Guide.ent">
%BOOK_ENTITIES;
]>
<section id="VDSM_hooks_examples" remap="TID_8297">
	<title>VDSM Hook Examples</title>
	<para>
		The example hook scripts provided in this section are strictly not supported by Red Hat. You must ensure that any and all hook scripts that you install to your system, regardless of source, are thoroughly tested for your environment.
	</para>
	<example id="VDSM_Hooks-example-numaset">
		<title><acronym>NUMA</acronym> Node Tuning</title>
		<formalpara>
			<title>Purpose:</title>
			<para>
				This hook script allows for tuning the allocation of memory on a NUMA host based on the <literal>numaset</literal> custom property. Where the custom property is not set no action is taken.
			</para>
		</formalpara>
		<formalpara>
			<title>Configuration String:</title>
			<para>
				<screen>numaset=^(interleave|strict|preferred):[\^]?\d+(-\d+)?(,[\^]?\d+(-\d+)?)*$</screen>
			</para>
		</formalpara>
		<para>
			The regular expression used allows the <parameter>numaset</parameter> custom property for a given virtual machine to specify both the allocation mode (<literal>interleave</literal>, <literal>strict</literal>, <literal>preferred</literal>) and the node to use. The two values are separated by a colon (<literal>:</literal>). The regular expression allows specification of the <parameter>nodeset</parameter> as:
		</para>
		<itemizedlist>
			<listitem>
				<para>
					that a specific node (<literal>numaset=strict:1</literal>, specifies that only node 1 be used), or
				</para>
			</listitem>
			<listitem>
				<para>
					that a range of nodes be used (<literal>numaset=strict:1-4</literal>, specifies that nodes 1 through 4 be used), or
				</para>
			</listitem>
			<listitem>
				<para>
					that a specific node not be used (<literal>numaset=strict:^3</literal>, specifies that node 3 not be used), or
				</para>
			</listitem>
			<listitem>
				<para>
					any comma-separated combination of the above (<literal>numaset=strict:1-4,6</literal>, specifies that nodes 1 to 4, and 6 be used).
				</para>
			</listitem>
		</itemizedlist>
		<formalpara>
			<title>Script:</title>
			<para> 
				<filename>/usr/libexec/vdsm/hooks/before_vm_start/50_numa</filename>
				<programlisting>
#!/usr/bin/python

import os
import sys
import hooking
import traceback

'''
numa hook
=========
add numa support for domain xml:

&lt;numatune&gt;
    &lt;memory mode="strict" nodeset="1-4,^3" /&gt;
&lt;/numatune&gt;

memory=interleave|strict|preferred

numaset="1" (use one NUMA node)
numaset="1-4" (use 1-4 NUMA nodes)
numaset="^3" (don't use NUMA node 3)
numaset="1-4,^3,6" (or combinations)

syntax:
    numa=strict:1-4
'''

if os.environ.has_key('numa'):
    try:
        mode, nodeset = os.environ['numa'].split(':')

        domxml = hooking.read_domxml()

        domain = domxml.getElementsByTagName('domain')[0]
        numas = domxml.getElementsByTagName('numatune')

        if not len(numas) &gt; 0:
            numatune = domxml.createElement('numatune')
            domain.appendChild(numatune)

            memory = domxml.createElement('memory')
            memory.setAttribute('mode', mode)
            memory.setAttribute('nodeset', nodeset)
            numatune.appendChild(memory)

            hooking.write_domxml(domxml)
        else:
            sys.stderr.write('numa: numa already exists in domain xml')
            sys.exit(2)
    except:
        sys.stderr.write('numa: [unexpected error]: %s\n' % traceback.format_exc())
        sys.exit(2)
</programlisting>
			</para>
		</formalpara>
	</example>
</section>