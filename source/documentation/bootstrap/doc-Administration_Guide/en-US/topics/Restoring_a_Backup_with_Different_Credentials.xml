<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "../Administration_Guide.ent">
%BOOK_ENTITIES;
]>
<section id="Restoring_a_Backup_with_Different_Credentials">
	<title>Restoring a Backup with Different Credentials</title>
		<para>
			The <command>engine-backup</command> command can restore a backup to a machine on which the Red Hat Virtualization Manager has already been installed and set up, but the credentials of the database in the backup are different to those of the database on the machine on which the backup is to be restored. This is useful when you have taken a backup of an installation and want to restore the installation from the backup to a different system.
		</para>
	<important>
		<para>
			When restoring a backup to overwrite an existing installation, you must run the <command>engine-cleanup</command> command to clean up the existing installation before using the <command>engine-backup</command> command. Because the <command>engine-cleanup</command> command only cleans the engine database, and does not drop the database or delete the user that owns that database, you do not need to create a new database or specify the database credentials because the user and database already exist. However, if the credentials for the owner of the engine database are not known, you must change them before you can restore the backup.
		</para>
	</important>
	<procedure>
		<title>Restoring a Backup with Different Credentials</title>
		<step>
			<para>
				Log on to the machine on which the Red Hat Virtualization Manager is installed.
			</para>
		</step>
		<step>
			<para>
				Run the following command and follow the prompts to remove the configuration files for and clean the database associated with the Manager:
			</para>
			<screen># engine-cleanup</screen>
		</step>
		<step>
			<para>
				Change the password for the owner of the engine database if the credentials of that user are not known:
			</para>
			<procedure>
				<step>
					<para>
						Enter the postgresql command line:
					</para>
					<screen># su postgres
$ psql</screen>
				</step>
				<step>
					<para>
						Change the password of the user that owns the <literal>engine</literal> database:
					</para>
					<screen>postgres=# alter role <replaceable>user_name</replaceable> encrypted password '<replaceable>new_password</replaceable>';</screen>
					<para>
						Repeat this for the user that owns the <literal>ovirt_engine_dwh</literal> database if necessary.
					</para>
				</step>
			</procedure>
		</step>
		<step>
			<para>
				Restore a complete backup or a database-only backup with the <parameter>--change-db-credentials</parameter> parameter to pass the credentials of the new database. The <replaceable>database_location</replaceable> for a database local to the Manager is <literal>localhost</literal>.
			</para>
			<note>
				<para>
					The following examples use a <literal>--*password</literal> option for each database without specifying a password, which will prompt for a password for each database. Passwords can be supplied for these options in the command itself, however this is not recommended as the password will then be stored in the shell history. Alternatively, <literal>--*passfile=</literal><replaceable>password_file</replaceable> options can be used for each database to securely pass the passwords to the <literal>engine-backup</literal> tool without the need for interactive prompts.
				</para>
			</note>
			<stepalternatives>
				<step>
					<para>
						Restore a complete backup:
					</para>
					<screen># engine-backup --mode=restore --file=<replaceable>file_name</replaceable> --log=<replaceable>log_file_name</replaceable> --change-db-credentials --db-host=<replaceable>database_location</replaceable> --db-name=<replaceable>database_name</replaceable> --db-user=engine --db-password --no-restore-permissions</screen>
					<para>
						If Data Warehouse is also being restored as part of the complete backup, include the revised credentials for the additional database: 
						<screen>engine-backup --mode=restore --file=<replaceable>file_name</replaceable> --log=<replaceable>log_file_name</replaceable> --change-db-credentials --db-host=<replaceable>database_location</replaceable> --db-name=<replaceable>database_name</replaceable> --db-user=engine --db-password --change-dwh-db-credentials --dwh-db-host=<replaceable>database_location</replaceable> --dwh-db-name=<replaceable>database_name</replaceable> --dwh-db-user=ovirt_engine_history --dwh-db-password --no-restore-permissions</screen>
					</para>
				</step>
				<step>
					<para>
						Restore a database-only backup by restoring the configuration files and the database backup:
					</para>
					<screen># engine-backup --mode=restore --scope=files --scope=db --file=<replaceable>file_name</replaceable> --log=<replaceable>log_file_name</replaceable> --change-db-credentials --db-host=<replaceable>database_location</replaceable> --db-name=<replaceable>database_name</replaceable> --db-user=engine --db-password --no-restore-permissions</screen>
					<para>
						The example above restores a backup of the Manager database.
					</para>
					<screen># engine-backup --mode=restore --scope=files --scope=dwhdb --file=<replaceable>file_name</replaceable> --log=<replaceable>log_file_name</replaceable> --change-dwh-db-credentials --dwh-db-host=<replaceable>database_location</replaceable> --dwh-db-name=<replaceable>database_name</replaceable> --dwh-db-user=ovirt_engine_history --dwh-db-password --no-restore-permissions</screen>
					<para>
						The example above restores a backup of the Data Warehouse database.
					</para>
				</step>
			</stepalternatives>
			<para>
				If successful, the following output displays:
			</para>
			<screen>You should now run engine-setup.
Done.</screen>
		</step>
		<step>
			<para>
				Run the following command and follow the prompts to reconfigure the firewall and ensure the <literal>ovirt-engine</literal> service is correctly configured:
			</para>
			<screen># engine-setup</screen>
		</step>
	</procedure>
</section>

