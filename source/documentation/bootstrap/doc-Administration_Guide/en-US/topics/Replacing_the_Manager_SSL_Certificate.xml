<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE section PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "../Administration_Guide.ent">
%BOOK_ENTITIES;
]>
<section id="Replacing_the_Manager_SSL_Certificate">
	<title>Replacing the Red Hat Virtualization Manager SSL Certificate</title>
	<warning>
		<para>
			Do not change the permissions and ownerships for the <filename>/etc/pki</filename> directory or any subdirectories. The permission for the <filename>/etc/pki</filename> and the <filename>/etc/pki/ovirt-engine</filename> directory must remain as the default 755.
		</para>
	</warning>
	<para>
		You want to use your organization's commercially signed certificate to identify your Red Hat Virtualization Manager to users connecting over HTTPS.
	</para>
	<note>
		<para>
			Using a commercially issued certificate for HTTPS connections does not affect the certificate used for authentication between your Manager and hosts. They will continue to use the self-signed certificate generated by the Manager.
		</para>
	</note>
	<formalpara>
		<title>Prerequisites</title>
		<para>
			This procedure requires a PEM formatted certificate from your commercial certificate issuing authority, a <emphasis>.nokey</emphasis> file, and a <emphasis>.cer</emphasis> file. The <emphasis>.nokey</emphasis> and <emphasis>.cer</emphasis> files are sometimes distributed as a certificate-key bundle in the P12 format.
		</para>
	</formalpara>
	<para>
		This procedure assumes that you have a certificate-key bundle in the <emphasis>P12</emphasis> format.
	</para>
	<important>
	  <para>
	    For new Red Hat Virtualization installations, you must complete all of the steps in this procedure. If you upgraded from a Red Hat Enterprise Virtualization 3.6 environment with a commercially signed certificate already configured, only steps 1, 8, and 9 are required.
	  </para>
	</important>
	<procedure>
		<title>Replacing the Red Hat Virtualization Manager Apache SSL Certificate</title>
		<step>
		  <para>
		    Add your commercially issued certificate to the host-wide trust store.
		  </para>
			<screen># cp <replaceable>YOUR-3RD-PARTY-CERT</replaceable>.pem /etc/pki/ca-trust/source/anchors</screen>
			<screen># update-ca-trust</screen>
		</step>
		<step>
			<para>
				The Manager has been configured to use <filename>/etc/pki/ovirt-engine/apache-ca.pem</filename>, which is symbolically linked to <filename>/etc/pki/ovirt-engine/ca.pem</filename>. Remove the symbolic link.
			</para>
			<screen># rm /etc/pki/ovirt-engine/apache-ca.pem</screen>
		</step>
		<step>
			<para>
			</para>
			<para>
				Save your commercially issued certificate as <filename>/etc/pki/ovirt-engine/apache-ca.pem</filename>. The certificate chain must be complete up to the root certificate. The chain order is important and should be from the last intermediate certificate to the root certificate.
			</para>
			<screen>mv <replaceable>YOUR-3RD-PARTY-CERT</replaceable>.pem /etc/pki/ovirt-engine/apache-ca.pem</screen>
		</step>
		<step>
			<para>
				Back up your <emphasis>P12</emphasis> bundle, and then move it to <filename>/etc/pki/ovirt-engine/keys/apache.p12</filename>.
			</para>
		</step>
		<step>
			<para>
				Extract the key from the bundle.
			</para>
			<screen># openssl pkcs12 -in  /etc/pki/ovirt-engine/keys/apache.p12 -nocerts -nodes &gt; /etc/pki/ovirt-engine/keys/apache.key.nopass</screen>
		</step>
		<step>
			<para>
				Extract the certificate from the bundle.
			</para>
			<screen># openssl pkcs12 -in /etc/pki/ovirt-engine/keys/apache.p12 -nokeys &gt; /etc/pki/ovirt-engine/certs/apache.cer</screen>
		</step>
		<step>
			<para>
				Restart the Apache server.
			</para>
			<screen># systemctl restart httpd.service</screen>
		</step>
		<step>
		  <para>
		    Create a new trust store configuration file. 
		  </para>
			<screen># vi /etc/ovirt-engine/engine.conf.d/99-custom-truststore.conf</screen>
			<para>
				Add the following content and save the file. 
			</para>
			<screen>ENGINE_HTTPS_PKI_TRUST_STORE="/etc/pki/java/cacerts"
ENGINE_HTTPS_PKI_TRUST_STORE_PASSWORD=""</screen>
		</step>
		<step>
		  <para>
		    Restart the <literal>ovirt-engine</literal> service. 
		  </para>
			<screen>systemctl restart ovirt-engine.service</screen>
		</step>
	</procedure>
	<para>
		Your users can now connect to the Administration and User portals without being warned about the authenticity of the certificate used to encrypt HTTPS traffic.
	</para>
	<important>
		<para>
			Replacing the certificate can cause the log collector to fail, as documented in <ulink url="https://access.redhat.com/solutions/458713" />. To avoid this failure, edit the log collector's configuration:
		</para>
		<procedure>
			<step>
				<para>
					Export the CA certificate from the CA server and copy it to the Red Hat Virtualization Manager server.
				</para>
			</step>
			<step>
				<para>
					Point the log collector to the new location by adding the following to <filename>/etc/ovirt-engine/logcollector.conf</filename>:
				</para>
				<screen>cert-file=<replaceable>/path/to/new/CA/file</replaceable></screen>
			</step>
		</procedure>
	</important>
</section>
